// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

// Enums
enum ExpenseCategory {
  flights
  accommodation
  food
  transportation
  attractions
  insurance
  shopping
  miscellaneous
}

enum SplitMethod {
  EQUAL      // Split equally among participants
  EXACT      // Exact amounts for each participant
  PERCENT    // Split by percentage
  WEIGHTS    // Split by custom weights
}

// User model
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  trips     Trip[]
}

// Trip model
model Trip {
  id               String        @id @default(cuid())
  userId           String
  name             String
  description      String?       @db.Text
  baseCurrency     String        // ISO 4217 currency code (e.g., "ILS", "USD")
  startDate        DateTime
  endDate          DateTime?
  travelStyle      String?       // e.g., "honeymoon", "family", "post-army", "urban", "other"
  travelStyleOther String?       // Custom style when travelStyle is "other"
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  
  // Relations
  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  participants     Participant[]
  expenses         Expense[]
  transfers        Transfer[]
  
  @@index([userId])
  @@index([startDate])
}

// Participant in a trip
model Participant {
  id        String   @id @default(cuid())
  tripId    String
  name      String
  email     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  trip              Trip           @relation(fields: [tripId], references: [id], onDelete: Cascade)
  expensesPaid      Expense[]      @relation("PaidByParticipant")
  expenseShares     ExpenseShare[]
  transfersFrom     Transfer[]     @relation("TransferFrom")
  transfersTo       Transfer[]     @relation("TransferTo")
  
  @@index([tripId])
  @@index([email])
}

// Expense model
model Expense {
  id          String          @id @default(cuid())
  tripId      String
  paidById    String          // Participant who paid
  description String
  amount      Decimal         @db.Decimal(12, 2) // Total amount
  currency    String          // ISO 4217 currency code
  category    ExpenseCategory
  date        DateTime        @default(now())
  notes       String?         @db.Text
  splitMethod SplitMethod     @default(EQUAL)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  // Relations
  trip        Trip            @relation(fields: [tripId], references: [id], onDelete: Cascade)
  paidBy      Participant     @relation("PaidByParticipant", fields: [paidById], references: [id], onDelete: Restrict)
  shares      ExpenseShare[]
  
  @@index([tripId])
  @@index([paidById])
  @@index([date])
  @@index([category])
}

// Expense share for each participant
model ExpenseShare {
  id            String   @id @default(cuid())
  expenseId     String
  participantId String
  amount        Decimal  @db.Decimal(12, 2) // Amount this participant owes/paid
  percent       Decimal? @db.Decimal(5, 2)  // Percentage (0-100) when using PERCENT split
  weight        Decimal? @db.Decimal(10, 2) // Weight when using WEIGHTS split
  createdAt     DateTime @default(now())
  
  // Relations
  expense       Expense     @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  
  @@unique([expenseId, participantId])
  @@index([expenseId])
  @@index([participantId])
}

// Transfer/Settlement between participants
model Transfer {
  id                String      @id @default(cuid())
  tripId            String
  fromParticipantId String
  toParticipantId   String
  amount            Decimal     @db.Decimal(12, 2)
  currency          String      // ISO 4217 currency code
  description       String?
  date              DateTime    @default(now())
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  // Relations
  trip              Trip        @relation(fields: [tripId], references: [id], onDelete: Cascade)
  fromParticipant   Participant @relation("TransferFrom", fields: [fromParticipantId], references: [id], onDelete: Restrict)
  toParticipant     Participant @relation("TransferTo", fields: [toParticipantId], references: [id], onDelete: Restrict)
  
  @@index([tripId])
  @@index([fromParticipantId])
  @@index([toParticipantId])
  @@index([date])
}
