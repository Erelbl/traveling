generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  createdAt DateTime @default(now())
  name      String?
  updatedAt DateTime @updatedAt
  Trip      Trip[]
}

model Trip {
  id               String        @id @default(cuid())
  userId           String
  name             String
  startDate        DateTime
  baseCurrency     String
  travelStyle      String?
  travelStyleOther String?
  createdAt        DateTime      @default(now())
  description      String?
  endDate          DateTime?
  updatedAt        DateTime      @updatedAt
  expenses         Expense[]
  participants     Participant[]
  transfers        Transfer[]
  User             User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([startDate])
  @@index([userId])
}

model Participant {
  id            String         @id @default(cuid())
  tripId        String
  name          String
  email         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  expensesPaid  Expense[]      @relation("PaidByParticipant")
  expenseShares ExpenseShare[]
  trip          Trip           @relation(fields: [tripId], references: [id], onDelete: Cascade)
  transfersFrom Transfer[]     @relation("TransferFrom")
  transfersTo   Transfer[]     @relation("TransferTo")

  @@index([tripId])
  @@index([email])
}

model Expense {
  id          String          @id @default(cuid())
  tripId      String
  amount      Decimal         @db.Decimal(12, 2)
  currency    String
  category    ExpenseCategory
  notes       String?
  createdAt   DateTime        @default(now())
  date        DateTime        @default(now())
  description String
  paidById    String
  splitMethod SplitMethod     @default(EQUAL)
  updatedAt   DateTime        @updatedAt
  paidBy      Participant     @relation("PaidByParticipant", fields: [paidById], references: [id])
  trip        Trip            @relation(fields: [tripId], references: [id], onDelete: Cascade)
  shares      ExpenseShare[]

  @@index([tripId])
  @@index([paidById])
  @@index([date])
  @@index([category])
}

model ExpenseShare {
  id            String      @id @default(cuid())
  expenseId     String
  participantId String
  amount        Decimal     @db.Decimal(12, 2)
  percent       Decimal?    @db.Decimal(5, 2)
  weight        Decimal?    @db.Decimal(10, 2)
  createdAt     DateTime    @default(now())
  expense       Expense     @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@unique([expenseId, participantId])
  @@index([expenseId])
  @@index([participantId])
}

model Transfer {
  id                String      @id @default(cuid())
  tripId            String
  fromParticipantId String
  toParticipantId   String
  amount            Decimal     @db.Decimal(12, 2)
  currency          String
  description       String?
  date              DateTime    @default(now())
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  fromParticipant   Participant @relation("TransferFrom", fields: [fromParticipantId], references: [id])
  toParticipant     Participant @relation("TransferTo", fields: [toParticipantId], references: [id])
  trip              Trip        @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@index([tripId])
  @@index([fromParticipantId])
  @@index([toParticipantId])
  @@index([date])
}

enum ExpenseCategory {
  flights
  accommodation
  food
  transportation
  attractions
  insurance
  shopping
  miscellaneous
}

enum SplitMethod {
  EQUAL
  EXACT
  PERCENT
  WEIGHTS
}
